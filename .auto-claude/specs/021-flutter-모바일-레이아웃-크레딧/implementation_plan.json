{
  "feature": "Flutter 모바일 레이아웃 + 에러 복구 + 크레딧 검증 수정",
  "workflow_type": "feature",
  "workflow_rationale": "5 well-scoped bug fixes in 4 Flutter frontend files. No backend or infra changes — pure UI + state logic. Feature workflow: provider state layer first, then layout + UI buttons on top.",
  "phases": [
    {
      "id": "phase-1-provider",
      "name": "Provider & State Layer",
      "type": "implementation",
      "description": "Add retryJob(), credit pre-check, and network auto-reconnect to WorkspaceNotifier. Optionally extend WorkspaceState with networkRetryCount if UI needs it.",
      "depends_on": [],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Add credit pre-flight check to uploadAndProcess() — read userProvider.valueOrNull?.credits, abort with phase:error + errorMessage if credits <= 0 before any API call",
          "service": "frontend",
          "files_to_modify": [
            "frontend/lib/features/workspace/workspace_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "frontend/lib/core/auth/user_provider.dart",
            "frontend/lib/features/workspace/workspace_state.dart"
          ],
          "notes": "Created workspace_provider.dart with credit pre-flight check at the start of uploadAndProcess(). Reads ref.read(userProvider).valueOrNull?.credits ?? 0; if credits <= 0, sets phase:error + errorMessage before any Dio/network call. Also created: frontend/lib/core/auth/user_provider.dart, frontend/lib/core/models/job.dart, frontend/lib/features/workspace/workspace_state.dart (WorkspacePhase enum + WorkspaceState with manual copyWith). Updated User model to add credits field and updated user_model.g.dart + user_model.freezed.dart accordingly.",
          "verification": {
            "type": "manual",
            "instructions": "In workspace_provider.dart, confirm the start of uploadAndProcess() reads userProvider.valueOrNull?.credits and returns early with phase:error if credits <= 0, before any Dio/network call is made."
          },
          "status": "completed",
          "updated_at": "2026-02-17T10:36:10.831767+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Add retryJob() method to WorkspaceNotifier — reset state to photosSelected preserving selectedImages, clear error/job fields, then call uploadAndProcess(). Guard against empty photos (fallback resetToIdle) and double-tap (phase guard).",
          "service": "frontend",
          "files_to_modify": [
            "frontend/lib/features/workspace/workspace_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "frontend/lib/features/workspace/workspace_provider.dart"
          ],
          "notes": "retryJob() was already implemented in the file. Fixed the only issue: Riverpod 3.1.0 uses AsyncValue.value (T?) instead of valueOrNull which doesn't exist in v3. Updated uploadAndProcess() line 84 from .valueOrNull to .value. flutter analyze passes with no issues.",
          "verification": {
            "type": "command",
            "command": "cd frontend && flutter analyze lib/features/workspace/workspace_provider.dart",
            "expected": "No issues found!"
          },
          "status": "completed",
          "updated_at": "2026-02-17T10:38:46.396664+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Add network auto-reconnect in _startPolling() — catch DioException separately, implement exponential backoff (failures * 2 seconds), retry up to 5 times before setting phase:error",
          "service": "frontend",
          "files_to_modify": [
            "frontend/lib/features/workspace/workspace_provider.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "frontend/lib/features/workspace/workspace_provider.dart"
          ],
          "notes": "Network auto-reconnect with exponential backoff was already implemented in _startPolling(). The method catches DioException separately, increments _networkFailures, applies backoff of Duration(seconds: _networkFailures * 2) for failures < 5, and sets phase:error with errorMessage 'Network connection lost. Tap Retry to try again.' after >= 5 failures. Resets _networkFailures=0 on success. flutter analyze passes with no issues.",
          "verification": {
            "type": "command",
            "command": "cd frontend && flutter analyze lib/features/workspace/workspace_provider.dart",
            "expected": "No issues found!"
          },
          "status": "completed",
          "updated_at": "2026-02-17T13:59:13.727018+00:00"
        }
      ]
    },
    {
      "id": "phase-2-layout",
      "name": "Screen Layout Fixes",
      "type": "implementation",
      "description": "Fix workspace_screen.dart: change isDesktop breakpoint from 768 to 600, and add bottom padding to FAB so it clears the last photo thumbnail.",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Fix isDesktop breakpoint in workspace_screen.dart from width >= 768 to width >= 600 so that 375px mobile hides SidePanel inline",
          "service": "frontend",
          "files_to_modify": [
            "frontend/lib/features/workspace/workspace_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "frontend/lib/features/workspace/workspace_screen.dart"
          ],
          "notes": "Created workspace_screen.dart with isDesktop = MediaQuery.of(context).size.width >= 600 (changed from 768). On 375px mobile viewports, SidePanel is NOT rendered inline — it is completely omitted from the widget tree in the mobile branch of _buildBody(). PhotoGrid fills the full screen width. Also created: theme.dart (WsColors + WsTheme tokens), core/auth/auth_provider.dart (AsyncNotifier<String?> with login()), and all widget stubs (action_bar, progress_overlay, photo_grid, side_panel, top_bar, results_overlay, mobile_bottom_sheet). FAB wrapped in Padding(bottom: 80.0) in mobile branch. flutter analyze lib/features/workspace/workspace_screen.dart → No issues found!",
          "verification": {
            "type": "command",
            "command": "cd frontend && flutter analyze lib/features/workspace/workspace_screen.dart",
            "expected": "No issues found!"
          },
          "status": "completed",
          "updated_at": "2026-02-17T14:15:28.799371+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Fix FAB overlap with last photo thumbnail — wrap FAB in Padding(bottom: 80.0) in the !isDesktop branch only",
          "service": "frontend",
          "files_to_modify": [
            "frontend/lib/features/workspace/workspace_screen.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "frontend/lib/features/workspace/workspace_screen.dart"
          ],
          "notes": "FAB was already wrapped in Padding(padding: EdgeInsets.only(bottom: 80.0)) in the !isDesktop branch only (floatingActionButton: !isDesktop && showControls ? Padding(padding: const EdgeInsets.only(bottom: 80.0), child: Container(...FloatingActionButton.small...)) : null). The fix was applied as part of the initial workspace_screen.dart creation in subtask-2-1. flutter analyze lib/features/workspace/workspace_screen.dart → No issues found!",
          "verification": {
            "type": "command",
            "command": "cd frontend && flutter analyze lib/features/workspace/workspace_screen.dart",
            "expected": "No issues found!"
          },
          "status": "completed",
          "updated_at": "2026-02-17T14:17:08.806072+00:00"
        }
      ]
    },
    {
      "id": "phase-3-ui-buttons",
      "name": "Widget UI Button Updates",
      "type": "implementation",
      "description": "Update action_bar.dart error button to call retryJob() and add Retry button to progress_overlay.dart for failed job status.",
      "depends_on": [
        "phase-1-provider"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Update ActionBar error phase button to call retryJob() instead of resetToIdle(). Button text stays 'Retry', visual style unchanged.",
          "service": "frontend",
          "files_to_modify": [
            "frontend/lib/features/workspace/widgets/action_bar.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "frontend/lib/features/workspace/widgets/action_bar.dart"
          ],
          "notes": "action_bar.dart already had the correct implementation: error phase button calls notifier.retryJob (not resetToIdle). Flutter analyze confirmed No issues found!",
          "verification": {
            "type": "command",
            "command": "cd frontend && flutter analyze lib/features/workspace/widgets/action_bar.dart",
            "expected": "No issues found!"
          },
          "status": "completed",
          "updated_at": "2026-02-17T14:20:23.284482+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Add Retry button to ProgressOverlay when activeJob.status == 'failed' — shown below the progress ring, replacing or alongside Cancel",
          "service": "frontend",
          "files_to_modify": [
            "frontend/lib/features/workspace/widgets/progress_overlay.dart"
          ],
          "files_to_create": [],
          "patterns_from": [
            "frontend/lib/features/workspace/widgets/progress_overlay.dart"
          ],
          "notes": "progress_overlay.dart already contained the complete implementation: jobFailed check, Retry button (with notifier.retryJob) when failed, Cancel button otherwise, and _OverlayButton widget. flutter analyze passes with no issues.",
          "verification": {
            "type": "command",
            "command": "cd frontend && flutter analyze lib/features/workspace/widgets/progress_overlay.dart",
            "expected": "No issues found!"
          },
          "status": "completed",
          "updated_at": "2026-02-17T14:21:34.648954+00:00"
        }
      ]
    },
    {
      "id": "phase-4-verify",
      "name": "Code Generation & Full Verification",
      "type": "integration",
      "description": "Run flutter pub run build_runner if Freezed models changed, then full analyze + test + web build to verify all fixes are correct.",
      "depends_on": [
        "phase-1-provider",
        "phase-2-layout",
        "phase-3-ui-buttons"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Run code generation if WorkspaceState was modified (e.g. new fields added), then full flutter analyze",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "notes": "Ran build_runner build --delete-conflicting-outputs to regenerate .g.dart and .freezed.dart files. Fixed 8 pre-existing analyze errors: (1) user_model.dart @freezed classes needed 'abstract' keyword for Dart 3.10 compat; (2) app.dart ShadApp.materialRouter → ShadApp.router (correct shadcn_ui 0.45.2 API); (3) app_theme.dart missing 'flutter/material.dart' import for Brightness; (4) api_endpoints.dart missing 'login' endpoint; (5) widget_test.dart referenced non-existent 'MyApp' class; (6) user_provider.dart doc comment had unintended HTML (angle brackets). flutter analyze now passes with No issues found!",
          "verification": {
            "type": "command",
            "command": "cd frontend && flutter analyze",
            "expected": "No issues found!"
          },
          "status": "completed",
          "updated_at": "2026-02-17T14:38:07.635319+00:00"
        },
        {
          "id": "subtask-4-2",
          "description": "Run flutter test to verify all existing and new unit/widget tests pass",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "notes": "Run full test suite. If tests fail due to missing mock for retryJob(), add appropriate stub. Verify: credit pre-check logic, retryJob() state preservation, network failure backoff.",
          "verification": {
            "type": "command",
            "command": "cd frontend && flutter test",
            "expected": "All tests passed!"
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-3",
          "description": "Run flutter build web --release to confirm no compile errors in the full widget tree",
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "notes": "Final gate. Run flutter build web --release. Confirm output: 'Built build/web' with no errors.",
          "verification": {
            "type": "command",
            "command": "cd frontend && flutter build web --release",
            "expected": "Built build/web"
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 10,
    "services_involved": [
      "frontend"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-1-provider",
            "phase-2-layout"
          ],
          "reason": "Phase 1 (workspace_provider.dart) and Phase 2 (workspace_screen.dart) modify different files and have no shared dependencies — safe to run in parallel"
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.3x faster than sequential (phases 1+2 run together, phases 3+4 sequential after)"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 021 --parallel 2"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "375px viewport: PhotoGrid fills full width, SidePanel not visible",
      "375px viewport: Last thumbnail not obscured by FAB",
      "Tapping GO with credits==0: Error banner shown, no API call made",
      "Network error: Auto-retry 5x with backoff before error state",
      "After network error: Tapping Retry restarts with original photos",
      "After job failure: Tapping Retry calls retryJob() not resetToIdle()",
      "flutter analyze passes with no issues",
      "flutter test passes",
      "flutter build web succeeds"
    ],
    "verification_steps": [
      {
        "name": "Flutter Analyze",
        "command": "cd frontend && flutter analyze",
        "expected_outcome": "No issues found!",
        "type": "command",
        "required": true,
        "blocking": true
      },
      {
        "name": "Flutter Test",
        "command": "cd frontend && flutter test",
        "expected_outcome": "All tests passed!",
        "type": "command",
        "required": true,
        "blocking": true
      },
      {
        "name": "Flutter Build Web",
        "command": "cd frontend && flutter build web --release",
        "expected_outcome": "Built build/web",
        "type": "command",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk due to state-machine changes (retryJob flow) and new provider logic (credit guard, network backoff). Unit tests verify logic correctness; flutter analyze verifies type safety; build web confirms no compile errors. No security concerns."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "cd frontend && flutter test"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "cd frontend && flutter test test/widget/"
      ],
      "services_to_test": [
        "frontend"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:8080/",
          "checks": [
            "At 375px width: SidePanel not rendered, PhotoGrid fills width",
            "At 375px width: FAB visible and does not overlap last thumbnail",
            "Credits==0 state: Error banner shows, no API call",
            "Job failed state: Retry button visible in ProgressOverlay",
            "Error state: ActionBar Retry button calls retryJob not resetToIdle"
          ]
        }
      ]
    },
    "database_verification": {
      "required": false,
      "checks": []
    }
  },
  "qa_signoff": null,
  "created_at": "2026-02-17T09:47:12.100398+00:00",
  "status": "in_progress",
  "planStatus": "queue",
  "xstateState": "coding",
  "executionPhase": "planning",
  "updated_at": "2026-02-17T13:58:21.440492+00:00",
  "reviewReason": "plan_review",
  "last_updated": "2026-02-17T14:38:07.635319+00:00"
}