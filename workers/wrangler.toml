name = "s3-workers"
main = "src/index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

# Required secrets (set via: wrangler secret put <SECRET_NAME>)
# - JWT_SECRET: Secret key for JWT token signing/verification
# - GPU_CALLBACK_SECRET: Secret for validating GPU worker callbacks
# For local development, copy .dev.vars.example to .dev.vars and set values

[durable_objects]
bindings = [
  { name = "USER_LIMITER", class_name = "UserLimiterDO" },
  { name = "JOB_COORDINATOR", class_name = "JobCoordinatorDO" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["UserLimiterDO", "JobCoordinatorDO"]

[[d1_databases]]
binding = "DB"
database_name = "s3-db"
database_id = "placeholder-replace-after-create"
migrations_dir = "migrations"

[[r2_buckets]]
binding = "R2"
bucket_name = "s3-images"

[[queues.producers]]
binding = "GPU_QUEUE"
queue = "gpu-jobs"

[[queues.consumers]]
queue = "gpu-jobs"
max_batch_size = 10
max_retries = 3
dead_letter_queue = "gpu-jobs-dlq"
